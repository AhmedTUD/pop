#!/bin/bash

# ุณูุฑูุจุช ุชุญุฏูุซ ุงููุณุชูุฏุน ุจุนุฏ ุงูุชูุธูู
# ูููู ุจุฅุถุงูุฉ ุฌููุน ุงููููุงุช ุงูุฌุฏูุฏุฉ ูุฑูุนูุง ูููุณุชูุฏุน

set -e

# ุงูุฃููุงู
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}๐ ุชุญุฏูุซ ุงููุณุชูุฏุน ุจุนุฏ ุชูุธูู ุงููุดุฑูุน${NC}"
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ git
if ! command -v git &> /dev/null; then
    echo -e "${RED}โ Git ุบูุฑ ูุซุจุช${NC}"
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ ูุณุชูุฏุน git
if [ ! -d ".git" ]; then
    echo -e "${RED}โ ูุฐุง ุงููุฌูุฏ ููุณ ูุณุชูุฏุน Git${NC}"
    echo -e "${YELLOW}๐ก ูุฅูุดุงุก ูุณุชูุฏุน ุฌุฏูุฏ:${NC}"
    echo "   git init"
    echo "   git remote add origin <repository-url>"
    exit 1
fi

# ุนุฑุถ ุญุงูุฉ Git
echo -e "${YELLOW}๐ ุญุงูุฉ ุงููุณุชูุฏุน ุงูุญุงููุฉ:${NC}"
git status --short

echo ""
echo -e "${YELLOW}๐ ุงููููุงุช ุงูุชู ุณูุชู ุฅุถุงูุชูุง:${NC}"

# ุนุฑุถ ุงููููุงุช ุงูุฌุฏูุฏุฉ ูุงููุนุฏูุฉ
git status --porcelain | while read status file; do
    case $status in
        "??") echo -e "   ${GREEN}+ $file${NC} (ููู ุฌุฏูุฏ)" ;;
        " M") echo -e "   ${YELLOW}~ $file${NC} (ูุนุฏู)" ;;
        "M ") echo -e "   ${YELLOW}~ $file${NC} (ูุนุฏู)" ;;
        " D") echo -e "   ${RED}- $file${NC} (ูุญุฐูู)" ;;
        "D ") echo -e "   ${RED}- $file${NC} (ูุญุฐูู)" ;;
        *) echo -e "   ${BLUE}? $file${NC} ($status)" ;;
    esac
done

echo ""
read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ (y/N): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}โ ุชู ุฅูุบุงุก ุงูุนูููุฉ${NC}"
    exit 0
fi

# ุฅุถุงูุฉ ุฌููุน ุงููููุงุช
echo -e "${YELLOW}๐ฆ ุฅุถุงูุฉ ุงููููุงุช...${NC}"
git add .

# ุนุฑุถ ุงููููุงุช ุงููุถุงูุฉ
echo -e "${GREEN}โ ุชู ุฅุถุงูุฉ ุงููููุงุช ุงูุชุงููุฉ:${NC}"
git diff --cached --name-status | while read status file; do
    case $status in
        "A") echo -e "   ${GREEN}+ $file${NC}" ;;
        "M") echo -e "   ${YELLOW}~ $file${NC}" ;;
        "D") echo -e "   ${RED}- $file${NC}" ;;
        *) echo -e "   ${BLUE}? $file${NC}" ;;
    esac
done

# ุฑุณุงูุฉ ุงูู commit
COMMIT_MESSAGE="๐งน ุชูุธูู ุงููุดุฑูุน ูุฅุนุฏุงุฏ ุงููุดุฑ ุงูุฌุฏูุฏ

โจ ุงูุชุญุณููุงุช:
- ุญุฐู 93+ ููู ุบูุฑ ุถุฑูุฑู (ุณูุฑูุจุชุงุช ุงููุดุฑ ุงููุฏููุฉุ ูููุงุช ุงูุชูุซูู ุงูุฒุงุฆุฏุฉ)
- ุงูุงุญุชูุงุธ ุจุงููููุงุช ุงูุฃุณุงุณูุฉ ููุท ููุชุทุจูู
- ุฅุถุงูุฉ ูููุงุช run.py ู setup.py ููุชุดุบูู ุงููุจุณุท
- ุชุญุฏูุซ README.md ููููู ุฃูุซุฑ ูุถูุญุงู ูุฏูุฉ
- ุฅุถุงูุฉ QUICK_START.md ููุจุฏุก ุงูุณุฑูุน

๐ ูููุงุช ุงููุดุฑ ุงูุฌุฏูุฏุฉ:
- deploy-guide.md: ุฏููู ุดุงูู ูููุดุฑ ุนูู VPS
- docker-compose.prod.yml: ุฅุนุฏุงุฏ Docker ููุฅูุชุงุฌ
- nginx-subdomain.conf: ุฅุนุฏุงุฏ Nginx ููุฏูููู ุงููุฑุนู
- deploy-to-vps.sh: ุณูุฑูุจุช ูุดุฑ ุชููุงุฆู
- update-repository.sh: ุณูุฑูุจุช ุชุญุฏูุซ ุงููุณุชูุฏุน

๐ง ุงููููุงุช ุงูุฃุณุงุณูุฉ ุงููุญููุธุฉ:
- app.py (ุงูุชุทุจูู ุงูุฑุฆูุณู)
- requirements.txt (ูุชุทูุจุงุช Python)
- database.db (ูุงุนุฏุฉ ุงูุจูุงูุงุช)
- static/ ู templates/ (ุงููุงุฌูุฉ ุงูุฃูุงููุฉ)
- ูููุงุช Docker ุงูุฃุณุงุณูุฉ
- ูููุงุช ุงูุฅุนุฏุงุฏ (.env, .gitignore, etc.)

๐ ุงููุชูุฌุฉ: ูุดุฑูุน ูุธูู ูููุธู ุฌุงูุฒ ูููุดุฑ ูุงูุชุทููุฑ"

# ุชูููุฐ ุงูู commit
echo -e "${YELLOW}๐พ ุญูุธ ุงูุชุบููุฑุงุช...${NC}"
git commit -m "$COMMIT_MESSAGE"

echo -e "${GREEN}โ ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ${NC}"

# ุงูุณุคุงู ุนู ุงูุฑูุน ูููุณุชูุฏุน ุงูุจุนูุฏ
echo ""
read -p "ูู ุชุฑูุฏ ุฑูุน ุงูุชุบููุฑุงุช ูููุณุชูุฏุน ุงูุจุนูุฏุ (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}๐ ุฑูุน ุงูุชุบููุฑุงุช...${NC}"
    
    # ุงูุญุตูู ุนูู ุงุณู ุงููุฑุน ุงูุญุงูู
    CURRENT_BRANCH=$(git branch --show-current)
    
    # ุฑูุน ุงูุชุบููุฑุงุช
    if git push origin $CURRENT_BRANCH; then
        echo -e "${GREEN}โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุจูุฌุงุญ ุฅูู ูุฑุน $CURRENT_BRANCH${NC}"
    else
        echo -e "${RED}โ ูุดู ูู ุฑูุน ุงูุชุบููุฑุงุช${NC}"
        echo -e "${YELLOW}๐ก ุชุญูู ูู:${NC}"
        echo "   - ุงุชุตุงู ุงูุฅูุชุฑูุช"
        echo "   - ุตูุงุญูุงุช ุงููุณุชูุฏุน"
        echo "   - ุฅุนุฏุงุฏุงุช Git"
        exit 1
    fi
else
    echo -e "${YELLOW}๐ ุงูุชุบููุฑุงุช ูุญููุธุฉ ูุญููุงู ููุท${NC}"
    echo -e "${BLUE}๐ก ูุฑูุนูุง ูุงุญูุงู ุงุณุชุฎุฏู:${NC}"
    echo "   git push origin $(git branch --show-current)"
fi

echo ""
echo -e "${GREEN}๐ ุชู ุชุญุฏูุซ ุงููุณุชูุฏุน ุจูุฌุงุญ!${NC}"
echo ""
echo -e "${BLUE}๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:${NC}"
echo -e "   1. ุฑุงุฌุน ุงููุณุชูุฏุน ุนูู GitHub/GitLab"
echo -e "   2. ุงุณุชุฎุฏู deploy-to-vps.sh ูููุดุฑ ุนูู ุงูุณูุฑูุฑ"
echo -e "   3. ุงุชุจุน ุงูุชุนูููุงุช ูู deploy-guide.md"
echo ""
echo -e "${YELLOW}๐ ูููุงุช ูููุฏุฉ:${NC}"
echo -e "   ๐ README.md - ูุนูููุงุช ุงููุดุฑูุน"
echo -e "   ๐ QUICK_START.md - ุงูุจุฏุก ุงูุณุฑูุน"
echo -e "   ๐ deploy-guide.md - ุฏููู ุงููุดุฑ"
echo -e "   ๐๏ธ deploy-to-vps.sh - ุณูุฑูุจุช ุงููุดุฑ"